name: cowsdb test runner
on:
  workflow_dispatch:
    inputs:
      clickhouse_tag:
        description: 'BuildTag for CowsDB (latest)'
        required: false
      clickhouse_image:
        description: 'Image for CowsDB (ghcr.io/cowsdb/cowsdb)'
        required: false

jobs:
  build:
    name: Run latest CowsDB
    runs-on: ubuntu-latest
    continue-on-error: true
    env:
      CLICKHOUSE_VERSION: "${{ github.event.inputs.clickhouse_image || 'ghcr.io/cowsdb/cowsdb' }}:${{ github.event.inputs.clickhouse_tag || 'latest' }}"
      QRYN_VERSION: "ghcr.io/metrico/qryn:${{ github.event.inputs.qryn_tag || 'latest' }}"
    services:
      clickhouse:
        image: "${{ github.event.inputs.clickhouse_image || 'ghcr.io/cowsdb/cowsdb' }}:${{ github.event.inputs.clickhouse_tag || 'latest' }}"
        ports:
          - 8123:8123
        env:
          PORT: 8123
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          repository: cowsdb/cowsdbench
          path: .
      - name: Wait for CowsDB API
        uses: mydea/action-wait-for-api@v1
        with:
          url: "http://localhost:8123/ping"
      - name: Megasweel
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf "/usr/local/share/boost"
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
      - name: WIP Bench
        run: |
          curl https://datasets.clickhouse.com/hits/tsv/hits_v1.tsv.xz | unxz --threads=`nproc` > hits_v1.tsv
          curl -G --data-urlencode "query=$(cat create.sql)" 'http://test:test@localhost:8123'
          echo hit_v1s.tsv | curl -X POST --data-urlencode "query=INSERT INTO clickbench.hits FORMAT TSV" 'http://test:test@localhost:8123' --data-binary @-
          rm -rf hits_v1.tsv
      - name: WIP Query
        run: |
           curl -G --data-urlencode "query=SELECT * FROM clickbench.hits LIMIT 10" 'http://test:test@localhost:8123'
      - name: Pull Docker logs
        run: |
         docker logs "${{ job.services.clickhouse.id }}"
